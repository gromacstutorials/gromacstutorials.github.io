<!DOCTYPE html>
<html lang="en">
    <!-- HEAD -->
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width,
        initial-scale=1, minimum-scale=1.0, shrink-to-fit=no">
        <link href="../figures/favicon-32x32.png" rel="icon" />
        <title>Salt solution</title>
        <meta name="description" content="Salt solution">
        <meta name="author" content="Simon Gravelle">
        <link rel="stylesheet" type="text/css"
        href="../assets_tutorials/vendor/bootstrap/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css"
        href="../assets_tutorials/vendor/font-awesome/css/all.min.css" />
        <link rel="stylesheet" type="text/css"
        href="../assets_tutorials/css/stylesheet.css" />
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-BFND91CYC2"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-BFND91CYC2');
        </script>
        <script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </head>
    <body data-spy="scroll" data-target=".idocs-navigation" data-offset="125">
        <div id="main-wrapper">
            <!-- HEADER -->
            <header id="header" class="sticky-top">
                <nav class="primary-menu navbar navbar-expand-lg navbar-dropdown-dark">
                    <div class="container-fluid">
                        <a class="logo ml-md-3" href="../index.html" title="LAMMPS tutorials">
                        <img src="../figures/logo.png"
                        alt="GROMACS tutorials" height="60"/>
                        </a>
                        <div id="header-nav" class="collapse navbar-collapse justify-content-end">
                            <ul class="navbar-nav">
                            <li>
                                <a href="../index.html">All tutorials</a>
                            </li>
                            <li>
                                <a href="../miscellaneous/contact.html">Contact me</a>
                            </li>
                            </ul>
                        <ul class="social-icons social-icons-sm ml-lg-2 mr-2">
                            <li class="social-icons-twitter"><a data-toggle="tooltip"
                            href="https://twitter.com/GravelleSimon" target="_blank"
                            title="" data-original-title="Twitter">
                            <i class="fab fa-twitter"></i></a></li>
                            <li class="social-icons-twitter"><a data-toggle="tooltip"
                            href="https://gitlab.com/sgravelle" target="_blank"
                            title="" data-original-title="Gitlab">
                            <i class="fab fa-gitlab"></i></i></a></li>
                            <li class="social-icons-twitter"><a data-toggle="tooltip"
                            href="https://github.com/simongravelle" target="_blank"
                            title="" data-original-title="Github">
                            <i class="fab fa-github"></i></i></a></li>
                            <li class="social-icons-twitter"><a data-toggle="tooltip"
                            href="https://www.youtube.com/c/SimonGravelle"
                            target="_blank" title="" data-original-title="Youtube">
                            <i class="fab fa-youtube"></i></i></a></li>
                        </ul>
                    </div>
                </nav>
            </header>
            <!-- sidebar -->
            <div class="idocs-navigation bg-light">
                <ul class="nav flex-column ">
                    <li class="nav-item">
                        <a class="nav-link active" href="#intro">Getting Started</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#installation">Installation</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#input">Input files</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#minimization">Energy minimization</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#minnvt">Minimalist NVT</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#impnvt">Improved NVT</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#npt">NPT</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#prod">Diffusion coefficient measurement</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#further">Going further</a>
                    </li>
                </ul>
            </div>
            <!-- main page -->
            <div class="idocs-content">
                <div class="container">
                    <section id="intro">
                        <h1>Salt solution</h1>
                        <h3>The very basics of GROMACS through a simple example:
                        a bulk solution of SO<sub>4</sub><sup>2-</sup> and Na<sup>+</sup>.</h3>
                        <p>
                            <img src="../figures/01-Na2SO4solution/Na2SO4_transparent.png"
                            style="width:33%" alt="Responsive image"/>
                            <img src="../figures/01-Na2SO4solution/msdgif.gif"
                            style="width:33%" alt="Responsive image"/>  <!--msd_alt.png-->
                            <p style="color:#6B6B6B">
                            Left: a water solution of SO<sub>4</sub><sup>2-</sup> and Na<sup>+</sup> ions visualized 
                            with VMD.
                            Right: calculated mean square displacement (MSD) for the ion SO<sub>4</sub><sup>2-</sup>.
                            </p>
                        </p>
                        <p>
                            <b>The objective of this tutorial</b> is to use the
                            open-source code GROMACS to perform
                            a simple molecular dynamics simulation: a liquid solution of water mixed with
                            sodium (Na<sup>+</sup>) and sulfate (SO<sub>4</sub><sup>2-</sup>) ions.
                            This tutorial illustrates several major ingredients of
                            molecular dynamics simulations, such as energy minimization, thermostating,
                            NVT and NPT equilibration,
                            and trajectory visualisation.
                        </p>
                        <p>
                            There are <b>no prerequisite</b> to follow this tutorial, but your life will be easier if 
                            you are familiar with using the terminal. 
                        </p>


                        <p class="alert alert-info">
                            <a href="../miscellaneous/contact.html">Click here</a> to contact me.
                        </p>
                    </section>
                    <br><br>
                    <!-- SECTION 0 -->
                    <section id="installation">
                        <h2>Software installation</h2>
                        <p>
                            GROMACS must be installed on your machine. You can install it
                            following the instructions of the
                            <a href="https://manual.gromacs.org/current/index.html" target="_blank"
                            class="removelinkdefault">GROMACS website</a>. Alternatively,
                            if you are using Ubuntu OS, you can simply execute the
                            following command in a terminal:
                            <pre><code>sudo apt-get install gromacs</code></pre>
                        </p>
                        <p>
                            If GROMACS is indeed installed on you computer, 
                            typing the following command in the terminal :
                            <pre><code>gmx</code></pre>
                        </p>
                        <p>
                            returns the version of GROMACS that has been
                            installed (on the top), I see:
                            <pre><code>:-) GROMACS - gmx, 2021.4 (-:</code></pre>
                        </p>
                        <p>
                            as well as a quote (at the bottom), such as 
                            <pre><code>GROMACS reminds you: "Computers are like humans - they do everything except think." (John von Neumann)</code></pre>
                        </p>
                        <p>
                            In addition to GROMACS, you will need the 3 following tools:
                            <ul>
                                <li>
                                    (1) <a href="https://help.gnome.org/users/gedit/stable/"
                            target="_blank" class="removelinkdefault"> a basic text
                            editing software</a> such as Vim, Gedit, or Notepad++,
                                </li>
                                <li>
                                    (2) <a href="https://www.ks.uiuc.edu/Research/vmd/"
                                    target="_blank" class="removelinkdefault"> a visualization
                                    software</a>, here I will use VMD (note: VMD is free but you
                                    have to register to the uiuc website in order to download
                                    it, alternatively you can also use Ovito.),
                                </li>
                                <li>
                                    (3) and <a href="https://plasma-gate.weizmann.ac.il/Grace/"
                                    target="_blank" class="removelinkdefault">a plotting
                                    tool</a> like XmGrace or pyplot.
                                </li>
                        </ul>     
                        </p>
                    </section>
                    <br><br>
                    <!-- SECTION 1 -->
                    <section id="input">
                        <h2>The input files</h2>
                        <p>  
                            In order to run the present simulation using GROMACS, we need the 3 following files:
                            <ul>
                                <li>
                                    1) a <b>configuration file</b> (.gro) containing the initial 
                                    positions of the atoms and the box dimensions,
                                </li>
                                <li>
                                    2) a <b>topology file</b> (.top) containing information
                                    about the force field (e.g. interaction parameters, molecular constraints),
                                </li>
                                <li>
                                    3) and an <b>input file</b> (.mdp) containing the parameters of the simulation (e.g. temperature, timestep).
                                </li>
                            </ul>
                        </p>
                        <br><br>
                        <h4>1) The configuration file (.gro)</h4>
                        <p>
                            For the present simulation, the initial atoms positions and box size are given in a conf.gro file (Gromos87 format) that you can download
                            by clicking <a target="_blank" href="../../inputs/01-Na2SO4solution/conf.gro">here</a>. Save the conf.gro file 
                            in a folder. The file looks like that:
                            <pre><code>Na2SO4 solution
3557
    1  SO4   O1    1   2.725   1.999   2.077
    1  SO4   O2    2   2.679   2.091   1.839
    1  SO4   O3    3   2.505   2.127   2.028
    1  SO4   O4    4   2.542   1.890   1.930
    1  SO4    S    5   2.612   2.027   1.968
  (...)
  898  SOL  HW1 3555   3.004   3.021   2.945
  898  SOL  HW2 3556   3.004   2.869   2.945
  898  SOL   MW 3557   2.955   2.945   2.945
   3.10000   3.10000   3.10000</code></pre>
                        </p>
                        <p>
                            <b>Description: </b> The first line is a comment, the second is the total number of atoms, and the last line is 
                            the box dimension in nanometer (nm). Between the second and the last line there is one line per atom. 
                            Each line indicates, from left to right, the 
                            residue Id (the atoms of the same SO<sub>4</sub><sup>2-</sup> ion have the same residue Id),
                            the residue name, the atom name, the atom Id, and finally the atom position (x, y, and z coordinate in nm).
                            <br><br>
                            <b>Remark: </b> The format of conf.gro file is fixed, all columns are in a fixed position. For example, the 
                            first five columns are for the residue number.
                            <br><br>
                            This conf.gro file can be visualized using VMD by typing in the terminal:
                            <pre><code>vmd conf.gro</code></pre>
                        </p>
                        <p>            
                           You have to play with atoms' representation and color to make it look better than it is by default.
                        </p>
                        <p>
                            <img src="../figures/01-Na2SO4solution/system_step0.png"
                            style="width:33%" alt="Responsive image"/>
                            <p style="color:#6B6B6B">
                            Figure: SO<sub>4</sub><sup>2-</sup> ions (in yellow and red) and Na<sub>+</sub> ions (blue) 
                            in water (red and white). 
                            </p>
                        </p>
                        <p>
                            As can be seen in this figure, the water molecules are arranged in a quite unrealistic regular manner, with all 
                            dipoles facing in the same direction, and possibly some overlapping between some of the atoms.
                        </p>
                        <br><br>
                        <h4>2) The topology file (.top)</h4>
                        <p>
                            The topology file contains information about the interactions of the different atoms and molecules. 
                            You can download it by clicking <a target="_blank" href="../../inputs/01-Na2SO4solution/topol.top">here</a>.
                            Place it in the same folder as the conf.gro file. The top file looks like that:
                            <pre><code>#include "ff/forcefield.itp"
#include "ff/h2o.itp"
#include "ff/na.itp"
#include "ff/so4.itp"

[ System ]
Na2SO4 solution

[ Molecules ]
SO4 7
Na 14
SOL 875</code></pre>
                        </p>
                        <p>
                            The 4 first lines are used to include the values the parameters given in separate files 
                            (its better for clarity). Create a folder named 'ff/', and copy 
                            <a target="_blank" href="../../inputs/01-Na2SO4solution/ff/forcefield.itp">forcefield.itp</a>,
                            <a target="_blank" href="../../inputs/01-Na2SO4solution/ff/h2o.itp">h2o.itp</a>,
                            <a target="_blank" href="../../inputs/01-Na2SO4solution/ff/na.itp">na.itp</a>, and
                            <a target="_blank" href="../../inputs/01-Na2SO4solution/ff/so4.itp">so4.itp</a> in it. 
                            These four files contain information about the atoms (names, masses,
                            changes, Lennard-Jones coefficients) and residues (bond and angular constraints).
                            <br><br>
                            The rest 
                            of the topol.top file contains the system name, and a list of the molecules. Its important that the order 
                            of the molecules in the topology file (here SO4 first, Na second, and SOL (H2O) last) matches the order 
                            of the conf.gro file. 
                        </p>
                        <br><br>
                        <h4>3) The input file (.mdp)</h4>
                        <p>
                            The input file contains instructions about the simulation, such as 
                            <ul>
                                <li>
                                    <b>-</b> the thermostat to be used (e.g. Langevin, Berendsen),
                                </li> 
                                <li>
                                    <b>-</b> the cut-off for the interactions (e.g. Lennard-Jones),
                                </li> 
                                <li>
                                    <b>-</b> or the molecular dynamics integrator (e.g. steep-decent, molecular dynamics).
                                </li> 
                            </ul>
                        </p>
                        <p>
                            In this tutorial, 4 different input files will be written in order to perform respectively an energy minimization
                            of the salt solution, an equilibration in the NVT ensemble, an equilibration in the NPT ensemble, and finally a production run. 
                            <br><br>
                            Input files will be placed in a 'inputs/' folder. At this point, your folder should look like that: 
                            <p>
                                <img src="../figures/01-Na2SO4solution/gromacs_inputs.png"
                                style="width:25%" alt="Responsive image"/>
                            </p>
                        </p>
                    </section>
                    <!-- SECTION 2 -->
                    <br><br>
                    <section id="minimization">
                        <h2>Energy minimization</h2>
                        <p>  
                            It is clear from the current conf file (see the previous image) that the atoms are currently in a 
                            quite unphysical configuration. It would be risky to directly perform a molecular dynamics simulation:
                            atoms would undergo huge forces and the system would explode. 
                            <br><br>
                            In order to bring the system into a favorable state, let us perform an energy minimization 
                            which consists in moving the atoms until the forces between them are reasonable. 
                        </p>
                        <p>
                            Open a blank file, call it min.mdp, and save it in the 'inputs/' folder. Copy the following 
                            lines into min.mdp: 
                            <pre><code>integrator = steep
nsteps = 5000</code></pre> 
                        </p>
                        <p>
                            These commands specify to GROMACS that the algorithm to be used is the speepest-descent, which move 
                            the atoms following the direction of the largest forces until 1 stopping criterial is reached. 
                            Then we specify the maximum number of steps to perform.<br><br>
                            In addition, we would like to be able to visualize the trajectory of the atoms during the 
                            minimization, so let us add the following command to the input file in order to 
                            print the atoms positions every 10 steps:
                            <pre><code>nstxout = 10</code></pre> 
                        </p>
                        <p>
                            We now have a very minimalist input script, let us try it.
                            From the terminal, type:
                            <pre><code>gmx grompp -f inputs/min.mdp -c conf.gro -p topol.top -o min -pp min -po min
gmx mdrun -v -deffnm min</code></pre> 
                        </p>
                        <p>
                            The first command (grompp) is used to preprocess the files in order to prepare the simulation. 
                            The grompp command also checks the validity of the files. Using the '-f', '-c', and '-p' keywords, 
                            we specify which input, configuration, and topology files must be used.
                            The other keywords '-o', '-pp', and '-po' are used to speficy the names of the 
                            output that will be produced during the run.
                            <br><br>
                            The second command (mdrun) calls the engine performing the computation from the 
                            preprocessed files (reconised thank to the -deffnm keyword). The '-v' option is here to 
                            enable verbose and have more information printed in the terminal.
                            <br><br>
                            If everything works, you should see something like :
                            <pre><code>Steepest Descents converged to machine precision in 824 steps,
but did not reach the requested Fmax < 10.
Potential Energy  = -6.8990930e+04
Maximum force     =  2.4094606e+02 on atom 1654
Norm of force     =  4.6640654e+01</code></pre> 
                        </p>
                        <p>
                            The information printed in the terminal indicates us that energy 
                            minimization has been performed, even though the precision that was asked 
                            from the default parameters was not reached. We can ignore this message. 
                            The final potential energy is large and negative, and the 
                            maximum force is small: 240 kJ/mol/nm (about 0.4 pN). Everything seems alright. 
                            <br><br>
                            Let us visualize the atoms' trajectories during the minimization step using VMD by typing:
                            <pre><code>vmd conf.gro min.trr</code></pre>
                        </p>
                        <p>
                            This is what I see:
                        </p>
                        <p>         
                            <img src="../figures/01-Na2SO4solution/min.gif"
                            style="width:33%" alt="Gif minimization system"/>
                            <p style="color:#6B6B6B">Movie showing the motion of the atoms during the energy minimization. 
                            <br><br>
                            <b>Note for VMD user:</b> You can avoid having molecules 'cut in half' by the periodic boundary conditions by rewriting the trajectory using 
                            'gmx trjconv -f min.trr -s min.tpr -o min_whole.trr -pbc whole' </p>
                        </p>
                        <p>
                            One can see that the molecules reorient themselves into more energetically favorable positions, and that 
                            the distances between the atoms are being progressively homogeneized. Let us have a look at the
                            evolution of the potential energy of the system. To do so, we can use the internal 'energy' command 
                            of GROMACS. In the 
                            terminal, type:  
                            <pre><code>gmx energy -f min.edr -o epotmin.xvg</code></pre>
                        </p>
                        <p>
                            and choose 'potential'. Here the edr file produced by Gromacs during the last run is used, and the result is saved in 
                            the epotmin.xvg file.                           
                            <br><br>
                            Let us plot it (xvg files can be easily openened using XmGrace, here I use pyplot and jupyter-notebook, find 
                            all my plotting scripts for this tutorial <a href="../../inputs/01-Na2SO4solution/plot/" download>here</a>):
                        </p>
                        <p>
                            <img src="../figures/01-Na2SO4solution/epotmin.png"
                            style="width:33%" alt="Responsive image"/>
                            <p style="color:#6B6B6B">Evolution of the potential energy as a function of the 
                            number of steps during energy minimization.</p>
                        </p>
                        <p>
                            <b>Observation:</b> One can see from the energy plot that the potential energy is initially huge and positive, 
                            which is the consequence of atoms being too close from one another, and to molecules being 
                            wrongly oriented. As the minimization progresses, the potential energy rapidly decreases and reaches a large and 
                            negative value, which is usually a good sign as it indicates that the atoms are now in an energetically favorable configuration.
                        </p>
                        <p>
                            The system is now ready for the molecular dynamics simulation.
                        </p>
                    </section>
                    <!-- SECTION 2 -->
                    <br><br>
                    <section id="minnvt">
                        <h2>Minimalist NVT input file</h2>
                        <p>
                            Let us first perform a small (20 picoseconds) equilibration in the NVT ensemble. For this 
                            simulation, the number of atom (N) and
                            volume (V) are maintained fixed, and temperature (T) is adjusted using a thermostat. 
                            Let use write a new input
                            script called nvt.mdp, and save it in the 'inputs/' folder.  Copy the following lines into it:
                            <pre><code>integrator = md
nsteps = 20000
dt = 0.001</code></pre>
                        </p>
                        <p>
                            Here the molecular dynamics (md) integrator is used (leapfrog algorithm), and a number of 20000
                            steps with timestep (dt) 0.001 ps is requested, so the total requested duration is 20 ps. 
                            Let us print the trajectory in a xtc file
                            every 1 ps by adding:
                            <pre><code>nstxout-compressed = 1000</code></pre>
                        </p>
                        <p>
                            Let us control the temperature 
                            over the course of the simulation using 
                            the v-rescale thermostat, which is the Berendsen thermostat with an additional stochastic term 
                            (it is known to give proper canonical ensemble):
                            <pre><code>tcoupl = v-rescale
ref-t = 360
tc-grps = system
tau-t = 0.5</code></pre>
                        </p>                  
                        <p>  
                            Here we also specified that the thermostat is applied to the entire system (we could choose 
                            to apply it only to a certain group of atom, which we will do later), and that 
                            the damping constant for the thermostat is 0.5 ps. 
                            <br><br>
                            <b>Remark: </b> The relatively high temperature of 360 K has been chosen here in order to reduce the 
                            viscosity of the solution and converge toward desired result faster. 
                            <br><br>
                            We now have a minimalist input file for performing the NVT step. Type in the terminal:
                            <pre><code>gmx grompp -f inputs/nvt.mdp -c min.gro -p topol.top -o nvt -pp nvt -po nvt
gmx mdrun -v -deffnm nvt</code></pre>
                        </p>
                        <p>   
                            Where '-c min.gro' ensures that the previously minimized configuration is used as a starting point.
                            <br><br>
                            After the completion of the simulation, we can ensure that the system temperature 
                            indeed reached the value of 360 K by using the energy
                            command of GROMACS. Type:  
                            <pre><code>gmx energy -f nvt.edr -o Tnvt.xvg</code></pre>
                        </p>
                        <p>
                            and choose 'temperature'. 
                            <br><br>
                            From the generated file, we can see that temperature started from 0, which was expected since the atoms 
                            have no velocity during a minimization step, and reaches a temperature slightly larger than the requested 360 K after 
                            a duration of a few picoseconds:
                        </p>
                        <p>
                            <img src="../figures/01-Na2SO4solution/Tnvt.png"
                            style="width:33%" alt="Responsive image"/>
                            <p style="color:#6B6B6B">Evolution of the temperature as a function of the 
                            time during the NVT equilibration. Dashed line is the requested temperature of 360 K.</p>
                        </p>
                    </section>
                    <!-- SECTION 3 -->
                    <br><br>
                    <section id="impnvt">
                        <h2>Improved NVT</h2>
                        <p>
                            So far, a very few commands have been placed in the NVT input file, meaning that most of the 
                            instruction have been taken by GROMACS from the default parameters. You can find
                            what parameters were used during the last nvt run by opening the new nvt.mdp file 
                            that has been created (i.e. not the one in the 'inputs/' folder, but the one in the main folder).
                            <br><br>
                            Exploring this new nvt.mdp file shows us that, for instance, plain cut-off Coulomb interactions have been 
                            used: 
                            <pre><code>; Method for doing electrostatics
coulombtype = Cut-off</code></pre>
                            </p>
                            <p>
                                For this system, long range Coulomb interaction is a better choice.
                                We could also better thermostat the system by thermostating water and 
                                ions separately. 
                                <br><br>
                                Therefore, let us improve the NVT step by specifying more options in
                                the input file. 
                                <br><br>
                                First, in nvt.mdp, let us impose the use of the long-range Fast smooth Particle-Mesh 
                                Ewald (SPME) electrostatics with Fourier spacing of 0.1 nm, order of 4, and 
                                cut-off of 4:
                                <pre><code>coulombtype = pme
fourierspacing = 0.1
pme-order = 4
rcoulomb = 1.0</code></pre>
                            </p>
                            <p>
                                <b>Note: </b> With PME, the cut-off specifies which interactions are treated with 
                                Fourier transforms.
                                <br><br>
                                Let us also specify the van der Waals interaction:
                                <pre><code>vdw-type = Cut-off
rvdw = 1.0</code></pre>
                            </p>
                            <p>
                                as well as the constraint algorithm for the hydrogen bonds of the water molecules:
                                <pre><code>constraint-algorithm = lincs
constraints = hbonds
continuation = no</code></pre>
                            </p>
                            <p>
                                Let us also perform separate temperature baths (for water and ions=non-water respectively) by replacing:
                                <pre><code>tcoupl = v-rescale
ref-t = 360
tc-grps = system
tau-t = 0.5</code></pre>
                            </p>
                            <p> 
                                by:
                                <pre><code>tcoupl = v-rescale
tc-grps = Water non-Water
tau-t = 0.5 0.5
ref-t = 360 360</code></pre>
                            </p>
                                Let us also specify neighbor searching parameters:
                            <p>
                                <pre><code>cutoff-scheme = Verlet
nstlist = 10
ns_type = grid</code></pre>
                            </p>
                                give an initial kick to the atom (so that the initial total velocities give 
                                the desired temperature instead of 0):
                            <p>
                                <pre><code>gen-vel = yes
gen-temp = 360</code></pre>
                            </p>
                            <p>
                                and let us remove center of mass translational velocity of the 
                                whose system:
                                <pre><code>comm_mode = linear
comm_grps = system</code></pre>
                            </p>
                            <p>
                                Run the new version of the input script. One obvious difference with the 
                                previous (minimalist) NVT run is the temperature at the beginning of the 
                                run (orange curve). In addition, the final temperature is closer to the 
                                desired temperature.
                            </p>
                            <p>
                                <img src="../figures/01-Na2SO4solution/Tnvt_improved.png"
                                style="width:33%" alt="Responsive image"/>
                                <p style="color:#6B6B6B">Evolution of the temperature as a function of the 
                                time during the NVT equilibration. The blue curve is from the minimalist NVT input file, and the 
                                orange curve is from the improved NVT input file. </p>
                            </p>
                    </section>
                    <!-- SECTION 4 -->
                    <br><br>
                    <section id="npt">
                        <h2>NPT</h2>
                        <p>
                            Now that the system is properly equilibrated in the NVT ensemble, let us perform an equilibration in 
                            the NPT ensemble, where the pressure is imposed and the volume of the box is free to relax, so that 
                            the density of the fluid converges toward equilibrium. 
                            <br><br>
                            Create a new input script, call it 'npt.mdp', and copy the following lines in it:
                            <pre><code>integrator = md
nsteps = 50000
dt = 0.001

comm_mode = linear
comm_grps = system

gen-vel = yes
gen-temp = 360

cutoff-scheme = Verlet
nstlist = 10
ns_type = grid

nstlog = 100
nstenergy = 100
nstxout-compressed = 1000

vdw-type = Cut-off
rvdw = 1.0

coulombtype = pme
fourierspacing = 0.1
pme-order = 4
rcoulomb = 1.0

constraint-algorithm = lincs
constraints = hbonds

tcoupl = v-rescale
ld-seed = 48456
tc-grps = Water non-Water
tau-t = 0.5 0.5
ref-t = 360 360

pcoupl = berendsen
Pcoupltype = isotropic
tau_p = 1.0
ref_p = 1.0
compressibility = 4.5e-5</code></pre>
                        </p>
                        <p>
                            The main difference with the previous NVT script, is the addition of the isotropic Berendsen pressure coupling with a 
                            target pressure of 1 bar. Another difference is the addition of the 'nstlog' and 'nstenergy' commands to 
                            control the frequency at which information are printed in the log file and in the energy file (edr).
                            Run it using : 
                            <pre><code>gmx grompp -f inputs/npt.mdp -c nvt.gro -p topol.top -o npt -pp npt -po npt
gmx mdrun -v -deffnm npt</code></pre>
                        </p>
                        <p>   
                            Let us have a look a both temperature, pressure and volume during the NPT step using the 'gmx energy' command.                            
                        </p>
                        <p>
                            <img src="../figures/01-Na2SO4solution/npt.png"
                            style="width:100%" alt="Responsive image"/>
                            <p style="color:#6B6B6B">From left to right: evolution of the temperature, pressure, and volume of the simulation box as a function of the 
                            time during the NPT equilibration.</p>
                        </p>
                        <p>  
                            The results show that the temperature remains well controlled during the NPT run. The 
                            results also show that the volume was initially too small 
                            for the desired pressure, and equilibrated itself at a slightly larger value after a few pico-seconds. 
                            Finally, the results show large oscillations of the pressure with time. These large oscillations are 
                            typical in molecular dynamics, particularly with liquid water 
                            that is particularly uncompressible. 
                        </p>
                    </section>
                    <!-- SECTION 5 -->
                    <br><br>
                    <section id="prod">
                        <h2>Diffusion coefficient measurement</h2>
                        <p>
                            Now that the system is fully equilibrated, we can perform a longer simulation and 
                            extract quantities of interest. Here, as an illustration, the diffusion coefficients 
                            of all 3 species (water and ions) will be measured. First, let us perform a longer run in 
                            the NVT ensemble. Create a new input file, call it 'pro.mdp' ('pro' is for 'production'), and 
                            copy the following lines into it:
                            <pre><code>integrator = md
nsteps = 200000
dt = 0.001

comm_mode = linear
comm_grps = system

gen-vel = yes
gen-temp = 360

cutoff-scheme = Verlet
nstlist = 10
ns_type = grid

nstlog = 100
nstenergy = 100
nstxout-compressed = 1000

vdw-type = Cut-off
rvdw = 1.0

coulombtype = pme
fourierspacing = 0.1
pme-order = 4
rcoulomb = 1.0

constraint-algorithm = lincs
constraints = hbonds

tcoupl = v-rescale
ld-seed = 48456
tc-grps = Water non-Water
tau-t = 0.5 0.5
ref_t = 360 360</code></pre>
                        </p>
                        <p>
                            And run it using : 
                            <pre><code>gmx grompp -f inputs/pro.mdp -c npt.gro -p topol.top -o pro -pp pro -po pro
gmx mdrun -v -deffnm pro</code></pre>
                        </p>
                        <p>
                            When its completed, compute the mean square displacement using:
                            <pre><code>gmx msd -f pro.xtc -s pro.tpr -o SO4.xvg</code></pre>
                        </p>
                        <p>
                            and select the SO4 ions. Fitting the slope of the MSD gives a value of 1.3e-5 cm<sup>2</sup>/s for the diffusion coefficient. For Na,
                            the value is 1.5e-5 cm<sup>2</sup>/s, and for water 5.2e-5 cm<sup>2</sup>/s (not too far from the 
                            experimental value of ~ 7e-5 cm<sup>2</sup>/s for T=360 K). 
                            <br><br>
                            <b>Side note:</b> Diffusion coefficients obtained from molecular dynamics simulations in a 
                            finite sized box must be corrected, but this is beyond the scope of the present tutorial, see 
                            this <a href="https://pubs.acs.org/doi/pdf/10.1021/acs.jpcb.1c05303", target="_blank">paper</a> for more details. 
                            <br><br>
                            The final MSDs plots look like this:
                        </p>
                        <p>
                            <img src="../figures/01-Na2SO4solution/MSD.png"
                            style="width:33%" alt="Responsive image"/>
                            <p style="color:#6B6B6B">MSDs for the three species, respectively.</p>
                        </p>
                    </section>
                    <br><br>
                    <!-- SECTION 6 -->
                    <section id="further">
                        <h2>Going further with exercises</h2>
                        <br>
                        <!--<p class="alert alert-info"> 
                        Request the solutions by email, or register <a target="_blank"
                        href="https://www.patreon.com/molecularsimulations">here</a> and access all the solutions
                        + additional LAMMPS/GROMACS content.
                        </p>-->
                        <br>
                        <h4><b>Measure the radial distribution function (RDF)</b></h4>
                        <p>
                        Using GROMACS internal commands (the same way we used 'gmx msd'), extract the 
                        radial distribution function between Na and SO4 ions. 
                        It should look like that:  
                        <!-- gmx rdf -f pro.xtc -s pro.tpr -o rdf_whole.xvg -> choose either 
                        system twice, or Na then SO4 -->
                        </p>
                        <p>
                            <img src="../figures/01-Na2SO4solution/RDF.png"
                            style="width:33%" alt="Responsive image"/>
                            <p style="color:#6B6B6B">RDF extracted from the Na2SO4 solution.</p>
                        </p>



                        <p class="alert alert-info">
                        <a href="../miscellaneous/contact.html">Click here</a>
                        to contact me.
                        </p>
                    </section>





















                </div>
            </div>
            <!-- Footer -->
            <footer id="footer" class="section">
                <div class="container">
                    <p class="text-2 text-center mb-0">This template has been adapted from
                    <a class="btn-link" target="_blank"
                    href="https://github.com/harnishdesign/iDocs/">HarnishDesign</a>.
                    </p>
                </div>
            </footer>
        </div>
        <!-- JavaScript -->
        <script src="../assets_tutorials/vendor/jquery/jquery.min.js"></script>
        <script src="../assets_tutorials/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="../assets_tutorials/vendor/highlight.js/highlight.min.js"></script>
        <script src="../assets_tutorials/vendor/jquery.easing/jquery.easing.min.js"></script>
        <script src="../assets_tutorials/vendor/magnific-popup/jquery.magnific-popup.min.js"></script>
        <script src="../assets_tutorials/js/theme.js"></script>
    </body>
</html>

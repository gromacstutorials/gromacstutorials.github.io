<!DOCTYPE html>
<html lang="en">
    <!-- HEAD -->
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width,
        initial-scale=1, minimum-scale=1.0, shrink-to-fit=no">
        <link href="../figures/favicon-32x32.png" rel="icon" />
        <title>Salt solution</title>
        <meta name="description" content="Salt solution">
        <meta name="author" content="Simon Gravelle">
        <link rel="stylesheet" type="text/css"
        href="../assets_tutorials/vendor/bootstrap/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css"
        href="../assets_tutorials/vendor/font-awesome/css/all.min.css" />
        <link rel="stylesheet" type="text/css"
        href="../assets_tutorials/css/stylesheet.css" />
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-BFND91CYC2"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-BFND91CYC2');
        </script>
        <script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </head>
    <body data-spy="scroll" data-target=".idocs-navigation" data-offset="125">
        <div id="main-wrapper">
            <!-- HEADER -->
            <header id="header" class="sticky-top">
                <nav class="primary-menu navbar navbar-expand-lg navbar-dropdown-dark">
                    <div class="container-fluid">
                        <a class="logo ml-md-3" href="../index.html" title="LAMMPS tutorials">
                        <img src="../figures/logo.png"
                        alt="GROMACS tutorials" height="60"/>
                        </a>
                        <div id="header-nav" class="collapse navbar-collapse justify-content-end">
                            <ul class="navbar-nav">
                            <li>
                                <a href="../index.html">All tutorials</a>
                            </li>
                            <li>
                                <a href="../miscellaneous/contact.html">Contact me</a>
                            </li>
                            </ul>
                        <ul class="social-icons social-icons-sm ml-lg-2 mr-2">
                            <li class="social-icons-twitter"><a data-toggle="tooltip"
                            href="https://twitter.com/GravelleSimon" target="_blank"
                            title="" data-original-title="Twitter">
                            <i class="fab fa-twitter"></i></a></li>
                            <li class="social-icons-twitter"><a data-toggle="tooltip"
                            href="https://gitlab.com/sgravelle" target="_blank"
                            title="" data-original-title="Gitlab">
                            <i class="fab fa-gitlab"></i></i></a></li>
                            <li class="social-icons-twitter"><a data-toggle="tooltip"
                            href="https://github.com/simongravelle" target="_blank"
                            title="" data-original-title="Github">
                            <i class="fab fa-github"></i></i></a></li>
                            <li class="social-icons-twitter"><a data-toggle="tooltip"
                            href="https://www.youtube.com/c/SimonGravelle"
                            target="_blank" title="" data-original-title="Youtube">
                            <i class="fab fa-youtube"></i></i></a></li>
                        </ul>
                    </div>
                </nav>
            </header>
            <!-- sidebar -->
            <div class="idocs-navigation bg-light">
                <ul class="nav flex-column ">
                    <li class="nav-item">
                        <a class="nav-link active" href="#intro">Getting Started</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#installation">Installation</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#input">Input files</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#minimization">Energy minimization</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#minnvt">Minimalist NVT</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#impnvt">Improved NVT</a>
                    </li>

                </ul>
            </div>
            <!-- main page -->
            <div class="idocs-content">
                <div class="container">
                    <section id="intro">
                        <h1>Salt solution</h1>
                        <h3>The very basics of GROMACS through a simple example:
                        a bulk solution of SO<sub>4</sub><sup>2-</sup> and Na<sup>+</sup>.</h3>
                        <p>
                            <img src="../figures/01-SimpleMolecularSimulation/main_image.png"
                            style="width:100%" alt="Responsive image"/>
                            <p style="color:#6B6B6B">
                            Figure: a binary fluid in a 2D box at 3 different times
                            </p>
                        </p>
                        <p>
                            <b>The objective of this tutorial</b> is to use the
                            open-source code GROMACS (derived from GROningen MAchine for Chemical Simulations) to perform
                            a simple molecular dynamics simulation: a liquid solution of water mixed with
                            sodium (Na<sup>+</sup>) and sulfate (SO<sub>4</sub><sup>2-</sup>) ions.
                            This tutorial illustrates several major ingredients of
                            molecular dynamics simulations, such as energy minimization, 
                            NVT and NPT equilibration, integration of the equations of motion,
                            and trajectory visualisation.
                        </p>
                        <p>
                            There are several parts to this tutorial:
                            <ul>
                                <li> 
                                    <a href="#installation">Softwares installation - </a>
                                    A quick look at the required softwares
                                </li>
                                <li> 
                                    <a href="#input">Inputs - </a>
                                    Generation of the input files
                                </li>
                            </ul>
                        </p>
                        <p class="alert alert-info">
                            <a href="../miscellaneous/contact.html">Click here</a> to contact me.
                        </p>
                    </section>
                    <br><br>
                    <!-- SECTION 0 -->
                    <section id="installation">
                        <h2>Software installation</h2>
                        <p>
                            GROMACS must be installed on your machine. You can install it
                            following the instructions of the
                            <a href="https://manual.gromacs.org/current/index.html" target="_blank"
                            class="removelinkdefault">GROMACS website</a>. Alternatively,
                            if you are using Ubuntu OS, you can simply execute the
                            following command in a terminal:
                            <pre><code>sudo apt-get install gromacs</code></pre>
                        </p>
                        <p>
                            You can verify that GROMACS is indeed installed on you computer
                            by typing in a terminal :
                            <pre><code>gmx</code></pre>
                        </p>
                        <p>
                            And you should see the version of GROMACS that has been
                            installed (on the top), I see:
                            <pre><code>:-) GROMACS - gmx, 2021.4 (-:</code></pre>
                        </p>
                        <p>
                            as well as a quote (at the bottom), such as 
                            <pre><code>GROMACS reminds you: "Computers are like humans - they do everything except think." (John von Neumann)</code></pre>
                        </p>
                        <p>
                            In addition to GROMACS, you will need the 3 following tools:
                            <ul>
                                <li>
                                    (1) <a href="https://help.gnome.org/users/gedit/stable/"
                            target="_blank" class="removelinkdefault"> a basic text
                            editing software</a> such as Vim, Gedit, or Notepad++,
                                </li>
                                <li>
                                    (2) <a href="https://www.ks.uiuc.edu/Research/vmd/"
                                    target="_blank" class="removelinkdefault"> a visualization
                                    software</a>, here I will use VMD (note: VMD is free but you
                                    have to register to the uiuc website in order to download
                                    it. If you don't want to, you can also use Ovito.),
                                </li>
                                <li>
                                    (3) and <a href="https://plasma-gate.weizmann.ac.il/Grace/"
                                    target="_blank" class="removelinkdefault">a plotting
                                    tool</a> like XmGrace or pyplot.
                                </li>
                        </ul>     
                        </p>
                    </section>
                    <br><br>
                    <!-- SECTION 1 -->
                    <section id="input">
                        <h2>The input files</h2>
                        <p>  
                            In order to run a simulation using GROMACS, one needs
                            to generate 3 files:
                            <ul>
                                <li>
                                    1) a <b>configuration file</b> (.gro) containing the initial 
                                    positions of the atoms and the box dimensions,
                                </li>
                                <li>
                                    2) a <b>topology file</b> (.top) containing information
                                    about the force field (interaction parameters, molecular constraint, etc.),
                                </li>
                                <li>
                                    3) and an <b>input file</b> (.mdp) containing the parameters of the simulation (temperature, timestep, etc.).
                                </li>
                            </ul>
                        </p>
                        <h4>1) The configuration file (.gro)</h4>
                        <p>
                            Here the atoms positions are given in a conf.gro file (Gromos87 format), which you can download
                            by clicking <a target="_blank" href="../../inputs/01-Na2SO4solution/conf.gro">here</a>.
                            The file looks like that:
                            <pre><code>Na2SO4 solution
3557
    1  SO4   O1    1   2.725   1.999   2.077
    1  SO4   O2    2   2.679   2.091   1.839
    1  SO4   O3    3   2.505   2.127   2.028
    1  SO4   O4    4   2.542   1.890   1.930
    1  SO4    S    5   2.612   2.027   1.968
  (...)
  898  SOL  HW1 3555   3.004   3.021   2.945
  898  SOL  HW2 3556   3.004   2.869   2.945
  898  SOL   MW 3557   2.955   2.945   2.945
   3.10000   3.10000   3.10000</code></pre>
                        </p>
                        <p>The first line is a comment, the second is the total number of atoms, and the last line is 
                            the box dimension in nanometer. Between the second and the last line are written 
                            exactly as many lines as there are atoms. Each line indicates, from left to right, the 
                            residue Id (the atoms of the same SO<sub>4</sub><sup>2-</sup> ion have the same residue Id),
                            the residue name, the atom name, the atom Id, and finally the position (x, y, and z).
                            <br><br>
                            This conf.gro file can be visualized using VMD/Ovito (play with atoms' representation
                            to make it look better than it is by default):
                        </p>
                        <p>
                            <img src="../figures/01-Na2SO4solution/system_step0.png"
                            style="width:33%" alt="Responsive image"/>
                            <p style="color:#6B6B6B">
                            Figure: SO<sub>4</sub><sup>2-</sup> ions (in yellow and red) and Na<sub>+</sub> ions (blue) 
                            in water (red and white). 
                            </p>
                        </p>
                        <p>
                            As can be seen in this figure, the water molecules are arranged in a quite unrealistic regular manner, with all 
                            dipoles facing in the same direction, and possibly some overlapping between some of the atoms.
                        </p>
                        <h4>2) The topology file (.top)</h4>
                        <p>
                            The topology file contains information about the interactions of the different atoms and molecules. 
                            You can download it by clicking <a target="_blank" href="../../inputs/01-Na2SO4solution/topol.top">here</a>.
                            Place it in the same folder as the conf.gro file. The top file looks like that:
                            <pre><code>#include "ff/forcefield.itp"
#include "ff/h2o.itp"
#include "ff/na.itp"
#include "ff/so4.itp"

[ System ]
Na2SO4 solution

[ Molecules ]

SO4 7
Na 14
SOL 875</code></pre>
                        </p>
                        <p>
                            The 4 first lines are used to include the values of the parameters, that are given in separate files 
                            for clarity. Create a folder named 'ff/', and copy 
                            <a target="_blank" href="../../inputs/01-Na2SO4solution/ff/forcefield.itp">forcefield.itp</a>,
                            <a target="_blank" href="../../inputs/01-Na2SO4solution/ff/h2o.itp">h2o.itp</a>,
                            <a target="_blank" href="../../inputs/01-Na2SO4solution/ff/na.itp">na.itp</a>, and
                            <a target="_blank" href="../../inputs/01-Na2SO4solution/ff/so4.itp">so4.itp</a> in it. The rest 
                            of the topol.top file contains the system name, and a list of the molecules. Its important that the order 
                            of the molecules in the topology file (here SO4 first, Na second, and SOL (H2O) last) matches the order 
                            of the conf.gro file. 
                            <br><br>
                            The four files located in the 'ff/' folder contain the information about the atoms (names, masses,
                            changes, Lennard-Jones coefficients) and residues (bond and angular constraints).
                        </p>
                        <h4>3) The input file (.mdp)</h4>
                        <p>
                            The input file contains instructions about the simulation, such as 
                            <ul>
                                <li>
                                    <b>-</b> the thermostat to be used (e.g. Langevin, Berendsen),
                                </li> 
                                <li>
                                    <b>-</b> the cut-off for the interactions (e.g. Lennard-Jones),
                                </li> 
                                <li>
                                    <b>-</b> or the molecular dynamics integrator (e.g. steep-decent, molecular dynamics).
                                </li> 
                            </ul>
                        </p>
                        <p>
                            In this tutorial, 4 different input files will be written in order to perform respectively an energy minimization
                            of the salt solution, an equilibration in the NVT ensemble, an equilibration in the NPT ensemble, and finally a production run. 
                        </p>
                    </section>
                    <!-- SECTION 2 -->
                    <br><br>
                    <section id="minimization">
                        <h2>Energy minimization</h2>
                        <p>  
                            It is clear from the current conf file (see the previous image) that the atoms are currently in a 
                            quite unphysical configuration. It would be risky to directly perform a molecular dynamics simulation,
                            as atoms would most likely undergo huge forces and make the system explode. <br><br>
                            In order to bring the system into a favorable state, let us perform an energy minimization 
                            which consists in moving the atoms until the forces between them are reasonable. 
                        </p>
                        <p>
                            Open a blank file, call it min.mdp, and save it in a folder called 'input/'. The new folder 'input/'
                            must be located in the same folder as 'ff/', 'topol.top', and 'conf.gro'. Copy the following 
                            lines into min.mdp: 
                            <pre><code>integrator = steep
nsteps = 5000</code></pre> 
                        </p>
                        <p>
                            These commands specify to GROMACS that the algorithm to be used is the speepest-descent, which move 
                            the atoms following the direction of the largest forces until 1 stopping criterial is reached. Then we specify the maximum number os steps to perform.<br><br>
                            In addition, we would like to be able to visualize the trajectory of the atoms during the 
                            minimization, so let us add the following command to the input file in order to 
                            print the atoms positions every 10 steps:
                            <pre><code>nstxout = 10</code></pre> 
                        </p>
                        <p>
                            We now have a very minimalist input script, let us try it.
                            From the terminal, type:
                            <pre><code>gmx grompp -f input/min.mdp -c conf.gro -p topol.top -o min -pp min -po min
gmx mdrun -v -deffnm min</code></pre> 
                        </p>
                        <p>
                            The first comand (grommp) is preprocessing the files in order to prepare the simulation. The grommp command also check the validity of the files. Using the '-f', '-c', and '-p' keywords, we specify which input, configuration, and topology files must be used.
                            The other keywords '-o', '-pp', and '-po' are here to speficy the names of the output that will be produced during the run.
                            <br><br>
                            The second command (mdrun) is the engine performing the computation from the preprocessed files (reconised thank to the -deffnm keyword). The '-v' option is here to turnon the verbose and have more information printed in te terminal.                             <br><br>
                            If everything goes according to the plan, you should see something like :
                            <pre><code>Steepest Descents converged to machine precision in 824 steps,
but did not reach the requested Fmax < 10.
Potential Energy  = -6.8990930e+04
Maximum force     =  2.4094606e+02 on atom 1654
Norm of force     =  4.6640654e+01</code></pre> 
                        </p>
                        <p>
                            It indicates us that energy minimization has been performed, even though the precision that was asked 
                            from the default parameters was not reached. This is fine, it really does not matter for us here. 
                            <br><br>
                            Let us visualize the atoms' trajectories during the minimization step. You should see something that
                            resemble:
                            <img src="../figures/01-Na2SO4solution/system_step0.png"
                            style="width:33%" alt="Responsive image"/>
                            <p style="color:#6B6B6B">[Add gif here]</p>
                        </p>
                        <p>
                            One can see that the molecules reorient themselves into more energetically favorable positions, and that 
                            the distances between the atoms are being progressively homogeneized. Let us have a look at the
                            evolution of the potential energy of the system. To do so, we can use the internal 'energy' command 
                            of GROMACS to analyze the simulation after it's been completed (post-mortem analyze). In the 
                            terminal, type:  
                            <pre><code>gmx energy -f min.edr -o epotmin.xvg</code></pre>
                        </p>
                        <p>
                            and choose 'potential'. Here the edr file produced by Gromacs during the last run is used, and the result is saved in 
                            the epotmin.xvg file. Let us plot it:
                        </p>
                        <p>
                            <img src="../figures/01-Na2SO4solution/epotmin.png"
                            style="width:33%" alt="Responsive image"/>
                            <p style="color:#6B6B6B">Evolution of the potential energy as a function of the 
                            number of steps during energy minimization.</p>
                        </p>
                        <p>
                            <b>Observation:</b> One can see from the energy plot that the potential energy is initially huge and positive, 
                            which is the consequence of atoms being too close from one another, and to molecules being 
                            wrongly oriented. As the minimization progresses, the potential energy rapidly decreases and reaches a large and 
                            negative value, which is usually a good sign as it indicates that the atoms are now in an energetically favorable configuration.
                        </p>
                        <p>
                            The system is now ready for the molecular dynamics simulation.
                        </p>
                    </section>
                    <!-- SECTION 2 -->
                    <br><br>
                    <section id="minnvt">
                        <h2>Minimalist NVT input file</h2>
                        <p>
                            Let us first perform a small (20 picoseconds) equilibration in the NVT ensemble, where the number of atom (N),
                            volume (V), and temperature are maintained fixed (T). For that, let use write a new input
                            script called nvt.mdp, and saved in the same 'input/' folder.  Copy the following lines into it:
                            <pre><code>integrator = md
nsteps = 20000
dt = 0.001</code></pre>
                        </p>
                        <p>
                            Here the molecular dynamics (md) integrator is used (leapfrog algorithm), and a number of 20000
                            steps with timestep (dt) 0.001 ps is requested. Let us print the trajectory in a xtc file
                            every 1 ps by adding:
                            <pre><code>nstxout-compressed = 1000</code></pre>
                        </p>
                        <p>
                            For NVT simulation, one needs to impose the temperature of the atoms. Let us control the temperature 
                            over the course of the simulation using 
                            the v-rescale thermostat, which is the Berendsen thermostat with a stochastic term (known to 
                            give proper canonical ensemble):
                            <pre><code>tcoupl = v-rescale
ref-t = 360
tc-grps = system
tau-t = 0.5</code></pre>
                        </p>                  
                        <p>  
                            Here we also specified that the thermostat is applied to the entire system (we could choose 
                            to apply it only to a certain group of atom, which is justified for some systems), and that 
                            the damping constant for the thermostat is 0.5 ps. 
                            <br><br>
                            <b>Remark: </b> The relatively high temperature of 360 K has been chosen here in order to reduce the 
                            viscosity of the solution and converge toward diffusion result faster. 
                            <br><br>
                            We now have a minimalist input file for performing the NVT step. Type in the terminal:
                            <pre><code>gmx grompp -f input/nvt.mdp -c min.gro -p topol.top -o nvt -pp nvt -po nvt
gmx mdrun -v -deffnm nvt</code></pre>
                        </p>
                        <p>   
                            Where '-c min.gro' ensures that the previously minimized configuration is used as a starting point.
                            <br><br>
                            After the completion of the simulation, we can ensure that the system temperature 
                            indeed reached the value of 360 K by using the energy
                            command of gromacs. Type:  
                            <pre><code>gmx energy -f nvt.edr -o Tnvt.xvg</code></pre>
                        </p>
                        <p>
                            and choose 'temperature'. The temperature starts from 0, which was expected since the atoms 
                            have no velocity during a minimization step, and reaches the requested temperature of 360 K after 
                            a duration of a few picosecond, in agreement with the imposed damping time (tau-t = 0.5 ps):
                        </p>
                        <p>
                            <img src="../figures/01-Na2SO4solution/Tnvt.png"
                            style="width:33%" alt="Responsive image"/>
                            <p style="color:#6B6B6B">Evolution of the temperature as a function of the 
                            time during the NVT equilibration.</p>
                        </p>
                    </section>
                    <!-- SECTION 3 -->
                    <br><br>
                    <section id="impnvt">
                        <h2>Improved NVT</h2>
                        <p>
                            So far, a very few commands were placed in the input file, meaning that most of the 
                            instruction have been taken by GROMACS from the default parameters. You can find
                            what parameters were used during the last nvt run by opening the new nvt.mpd file 
                            that has been created (not in the 'input/'' folder, but in the main folder).
                            <br><br>
                            Exploring this file, one can see for instance that plain cut-off Coulomb interactions have been 
                            used: 
                            <pre><code>; Method for doing electrostatics
coulombtype = Cut-off</code></pre>
                            </p>
                            <p>
                                For this system, long range Coulomb interaction is a better choice.
                                Therefore, let us improve the NVT step by specifying more options in
                                the input file. 
                                <br><br>
                                First, in nvt.mdp, let us impose the use of the long-range Fast smooth Particle-Mesh 
                                Ewald (SPME) electrostatics with Fourier spacing of 0.1 nm, order of 4, and 
                                cut-off of 4:
                                <pre><code>coulombtype = pme
fourierspacing = 0.1
pme-order = 4
rcoulomb = 1.0</code></pre>
                            </p>
                            <p>
                                <b>Note: </b> With PME, the cut-off specifies which interactions are treated with 
                                Fourier transforms.
                                <br><br>
                                Let us also specify the van der Waals interaction:
                                <pre><code>vdw-type = Cut-off
rvdw = 1.0</code></pre>
                            </p>
                            <p>
                                as well as the constraint algorithm for the hydrogen bonds of the water molecules:
                                <pre><code>constraint-algorithm = lincs
constraints = hbonds
continuation = no</code></pre>
                            </p>
                            <p>
                                Let us also perform separate temperature baths (for water and ions=non-water respectively):
                                <pre><code>tcoupl = v-rescale
tc-grps = Water non-Water
tau-t = 0.5 0.5
ref-t = 360 360</code></pre>
                            </p>
                                Let us also specify neighbor searching parameters:
                            <p>
                                <pre><code>cutoff-scheme = Verlet
nstlist = 10
ns_type = grid</code></pre>
                            </p>
                                give an initial kick to the atom (to that the initial velocity is 
                                close to the desired value):
                            <p>
                                <pre><code>gen-vel = yes
gen-temp = 360</code></pre>
                            </p>
                            <p>
                                and let us remove center of mass translational velocity of the 
                                whose system:
                                <pre><code>comm_mode = linear
comm_grps = system</code></pre>
                            </p>
                            <p>
                                Run the new version of the input script. One obvious difference with the 
                                previous (minimalist) NVT run is the temperature at the beginning of the 
                                run (orange curve). In addition, the final temperature is closer to the 
                                desired temperature.
                            </p>
                            <p>
                                <img src="../figures/01-Na2SO4solution/Tnvt_improved.png"
                                style="width:33%" alt="Responsive image"/>
                                <p style="color:#6B6B6B">Evolution of the temperature as a function of the 
                                time during the NVT equilibration. Blue curve is from the minimalist NVT input file, and the 
                                orange curve is from the improved NVT input file. </p>
                            </p>
                    </section>






                    <!-- SECTION N -->
                    <section id="further">
                        <h2>Going further with exercises</h2>
                        <br>
                        <p class="alert alert-info"> 
                        Request the solutions by email, or register <a target="_blank"
                        href="https://www.patreon.com/molecularsimulations">here</a> and access all the solutions
                        + additional LAMMPS content.
                        </p>
                        <br>
                        <h4><b>Preamble :</b></h4>
                        <p>
                        Text here...
                        </p>

                        <p class="alert alert-info">
                        <a href="../miscellaneous/contact.html">Click here</a>
                        to contact me.
                        </p>
                    </section>
                </div>
            </div>
            <!-- Footer -->
            <footer id="footer" class="section">
                <div class="container">
                    <p class="text-2 text-center mb-0">This template has been adapted from
                    <a class="btn-link" target="_blank"
                    href="https://github.com/harnishdesign/iDocs/">HarnishDesign</a>.
                    </p>
                </div>
            </footer>
        </div>
        <!-- JavaScript -->
        <script src="../assets_tutorials/vendor/jquery/jquery.min.js"></script>
        <script src="../assets_tutorials/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="../assets_tutorials/vendor/highlight.js/highlight.min.js"></script>
        <script src="../assets_tutorials/vendor/jquery.easing/jquery.easing.min.js"></script>
        <script src="../assets_tutorials/vendor/magnific-popup/jquery.magnific-popup.min.js"></script>
        <script src="../assets_tutorials/js/theme.js"></script>
    </body>
</html>
